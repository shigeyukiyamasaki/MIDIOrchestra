<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIDI Orchestra Visualizer</title>
  <link rel="stylesheet" href="style.css?v=2">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
  <!-- コントロールパネル -->
  <div id="controls">
    <div class="control-group file-inputs">
      <div id="midiDropZone" class="file-row">
        <span class="file-label">MIDI</span>
        <input type="file" id="midiInput" accept=".mid,.midi">
        <span id="midiFileName">未選択（ドロップ可）</span>
        <button class="library-btn" data-slot="midi">ライブラリ</button>
        <button id="midiClearBtn" class="clear-btn" style="display:none;"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="audioDropZone" class="file-row">
        <span class="file-label">音源</span>
        <input type="file" id="audioInput" accept="audio/*">
        <span id="audioFileName">未選択（ドロップ可）</span>
        <button class="library-btn" data-slot="audio">ライブラリ</button>
        <button id="audioClearBtn" class="clear-btn" style="display:none;"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </div>
    <div class="control-group sync-controls">
      <div class="sync-row">
        <label>MIDI遅延</label>
        <input type="range" id="midiDelay" min="0" max="3" step="0.05" value="0">
        <span id="midiDelayValue">0.00秒</span>
      </div>
      <div class="sync-row">
        <label>音源遅延</label>
        <input type="range" id="audioDelay" min="0" max="3" step="0.05" value="0">
        <span id="audioDelayValue">0.00秒</span>
      </div>
    </div>
    <div class="control-group playback-group">
      <div class="control-group">
        <button id="rewBtn"><i class="fa-solid fa-backward"></i></button>
        <button id="playBtn" disabled><i class="fa-solid fa-play"></i></button>
        <button id="stopBtn" disabled><i class="fa-solid fa-stop"></i></button>
        <button id="ffBtn"><i class="fa-solid fa-forward"></i></button>
        <select id="aspectRatioSelect" style="margin-left:auto;">
          <option value="16:9">16:9</option>
          <option value="9:16">9:16</option>
          <option value="free">フリー</option>
        </select>
      </div>
      <div class="control-group seek-group">
        <label><span id="currentTime">0:00</span> <span id="editorDuration">/ 0:00</span></label>
        <div class="seek-bar-container">
          <input type="range" id="editorSeek" min="0" max="100" step="0.1" value="0">
          <input type="range" id="loopEndSeek" min="0" max="1000" step="1" value="1000" class="loop-end-range">
        </div>
        <div class="loop-end-block">
          <label class="loop-end-label"><input type="checkbox" id="loopEndEnabled"> 終点 <span id="loopEndTime">-:--.--</span> <span class="loop-end-btns"><button id="loopEndUp" class="loop-end-btn">▲</button><button id="loopEndDown" class="loop-end-btn">▼</button></span></label>
          <label class="loop-end-label">FO <input type="range" id="fadeOutDuration" min="1" max="10" step="1" value="1" style="width:60px;vertical-align:middle;"> <span id="fadeOutValue">0.1s</span></label>
        </div>
      </div>
    </div>
    <div class="control-group preset-controls">
      <select id="presetSelect"><option value="">プリセット選択...</option></select>
      <div class="preset-btn-stack">
        <button id="presetLoadBtn"><i class="fa-solid fa-folder-open"></i> 読込</button>
        <button id="presetSaveBtn"><i class="fa-solid fa-floppy-disk"></i> 保存</button>
      </div>
      <div class="preset-btn-stack">
        <button id="presetDeleteBtn"><i class="fa-solid fa-trash"></i> 削除</button>
        <button id="publishBtn"><i class="fa-solid fa-globe"></i> 公開</button>
      </div>
      <button id="export360Btn" title="360度動画書き出し"><i class="fa-solid fa-vr-cardboard"></i> 360°</button>
    </div>
  </div>

  <!-- 設定パネルコンテナ（2列） -->
  <div id="settings-container">
    <!-- カメラ設定パネル（左列） -->
    <div id="camera-panel" class="settings-column">
      <h3>カメラ設定</h3>
      <div id="camera-list">
        <!-- X軸（左右） -->
        <div class="setting-category">X (左右) <span id="cameraPosXValue" class="pos-value">-150</span></div>
        <div class="setting-item dual-range-container">
          <div class="dual-range" data-axis="X" data-min="-500" data-max="500">
            <div class="range-track"></div>
            <div class="range-selected"></div>
            <div class="range-handle min-handle" title="範囲下限"></div>
            <div class="range-handle max-handle" title="範囲上限"></div>
            <div class="current-marker" title="現在位置"></div>
          </div>
          <div class="range-values">
            <span id="cameraRangeXMinVal">-200</span>
            <span id="cameraRangeXMaxVal">200</span>
          </div>
        </div>

        <!-- Y軸（高さ） -->
        <div class="setting-category">Y (高さ) <span id="cameraPosYValue" class="pos-value">150</span></div>
        <div class="setting-item dual-range-container">
          <div class="dual-range" data-axis="Y" data-min="-100" data-max="500">
            <div class="range-track"></div>
            <div class="range-selected"></div>
            <div class="range-handle min-handle" title="範囲下限"></div>
            <div class="range-handle max-handle" title="範囲上限"></div>
            <div class="current-marker" title="現在位置"></div>
          </div>
          <div class="range-values">
            <span id="cameraRangeYMinVal">50</span>
            <span id="cameraRangeYMaxVal">300</span>
          </div>
        </div>

        <!-- Z軸（前後） -->
        <div class="setting-category">Z (前後) <span id="cameraPosZValue" class="pos-value">200</span></div>
        <div class="setting-item dual-range-container">
          <div class="dual-range" data-axis="Z" data-min="-500" data-max="500">
            <div class="range-track"></div>
            <div class="range-selected"></div>
            <div class="range-handle min-handle" title="範囲下限"></div>
            <div class="range-handle max-handle" title="範囲上限"></div>
            <div class="current-marker" title="現在位置"></div>
          </div>
          <div class="range-values">
            <span id="cameraRangeZMinVal">100</span>
            <span id="cameraRangeZMaxVal">300</span>
          </div>
        </div>

        <!-- 中心点 -->
        <div class="setting-category">中心点</div>
        <div class="setting-item">
          <label>X</label>
          <input type="range" id="cameraTargetX" min="-500" max="500" step="5" value="0">
          <span id="cameraTargetXValue">0</span>
        </div>
        <div class="setting-item">
          <label>Y</label>
          <input type="range" id="cameraTargetY" min="-100" max="100" step="5" value="0">
          <span id="cameraTargetYValue">0</span>
        </div>
        <div class="setting-item">
          <label>Z</label>
          <input type="range" id="cameraTargetZ" min="-500" max="500" step="5" value="0">
          <span id="cameraTargetZValue">0</span>
        </div>

        <!-- 自動切替 -->
        <div class="setting-category">自動切替</div>
        <div class="setting-item">
          <label>
            <input type="checkbox" id="autoCameraEnabled">
            自動カメラ切替
          </label>
        </div>
        <div class="setting-item">
          <label>切替間隔(秒)</label>
          <input type="range" id="autoCameraInterval" min="2" max="20" step="1" value="5">
          <span id="autoCameraIntervalValue">5</span>
        </div>

        <!-- トランジション -->
        <div class="setting-category">トランジション</div>
        <div class="setting-item">
          <label>モード</label>
          <select id="autoCameraMode">
            <option value="continuous">連続（カメラ移動）</option>
            <option value="cut">カット（クロスフェード）</option>
          </select>
        </div>
        <div class="setting-item" id="continuousModeParams">
          <label>移動時間(%)</label>
          <input type="range" id="autoCameraMovePercent" min="10" max="100" step="5" value="50">
          <span id="autoCameraMovePercentValue">50</span>
        </div>
        <div class="setting-item" id="cutModeParams" style="display: none;">
          <label>クロスフェード(秒)</label>
          <input type="range" id="autoCameraCrossfade" min="0.5" max="5" step="0.5" value="1.5">
          <span id="autoCameraCrossfadeValue">1.5</span>
        </div>
      </div>
    </div>

    <!-- エフェクトパネル -->
    <div id="effects-panel" class="settings-column">
      <h3>エフェクト</h3>
      <div id="effects-list">
        <!-- ノート通過時 -->
        <div class="setting-category">ノート通過時</div>
        <div class="setting-item">
          <label>バウンス (0=OFF)</label>
          <input type="range" id="bounceScale" min="0" max="5" step="0.5" value="1">
          <span id="bounceScaleValue">1</span>
        </div>
        <div class="setting-item">
          <label>バウンス時間</label>
          <input type="range" id="bounceDuration" min="0.1" max="0.5" step="0.05" value="0.2">
          <span id="bounceDurationValue">0.2</span>
        </div>
        <div class="setting-item">
          <label>アイコン (0=OFF)</label>
          <input type="range" id="popIconScale" min="0" max="10" step="0.1" value="3">
          <span id="popIconScaleValue">3</span>
        </div>
        <div class="setting-item">
          <label>
            <input type="checkbox" id="rippleEnabled" checked>
            波紋
          </label>
        </div>

        <!-- バスドラ専用 -->
        <div class="setting-category">バスドラ専用</div>
        <div class="setting-item">
          <label>幕フラッシュ</label>
          <input type="range" id="flashEffectIntensity" min="0" max="1" step="0.1" value="0">
          <span id="flashEffectIntensityValue">0</span>
        </div>

        <!-- テンポ専用 -->
        <div class="setting-category">テンポ専用</div>
        <div class="setting-item">
          <label>カメラ回転</label>
          <input type="range" id="beatCameraRotation" min="0" max="1" step="0.1" value="0">
          <span id="beatCameraRotationValue">0</span>
        </div>
        <div class="setting-item">
          <label>背景パルス</label>
          <input type="range" id="beatBackgroundPulse" min="0" max="1" step="0.1" value="0">
          <span id="beatBackgroundPulseValue">0</span>
        </div>
        <div class="setting-item">
          <label>カラーシフト</label>
          <input type="range" id="beatColorShift" min="0" max="1" step="0.1" value="0">
          <span id="beatColorShiftValue">0</span>
        </div>
        <div class="setting-item">
          <label>空間パルス</label>
          <input type="range" id="beatSpacePulse" min="0" max="1" step="0.1" value="0">
          <span id="beatSpacePulseValue">0</span>
        </div>
        <div class="setting-item">
          <label>ストロボ</label>
          <input type="range" id="beatStrobe" min="0" max="1" step="0.1" value="0">
          <span id="beatStrobeValue">0</span>
        </div>

        <!-- 選択式エフェクト -->
        <div class="setting-category">選択式（トリガー切替）</div>
        <div class="setting-item">
          <div class="effect-header">
            <label>カメラ揺れ</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectCameraShakeTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectCameraShakeTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectCameraShake" min="0" max="1" step="0.1" value="0">
          <span id="effectCameraShakeValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>カメラズーム</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectCameraZoomTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectCameraZoomTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectCameraZoom" min="0" max="1" step="0.1" value="0">
          <span id="effectCameraZoomValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>フラッシュ</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectFlashTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectFlashTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectFlash" min="0" max="1" step="0.1" value="0">
          <span id="effectFlashValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>ブラー</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectBlurTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectBlurTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectBlur" min="0" max="1" step="0.1" value="0">
          <span id="effectBlurValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>ひび割れ</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectCrackTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectCrackTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectCrack" min="0" max="1" step="0.1" value="0">
          <span id="effectCrackValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>グリッチ</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectGlitchTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectGlitchTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectGlitch" min="0" max="1" step="0.1" value="0">
          <span id="effectGlitchValue">0</span>
        </div>
      </div>
    </div>
    <!-- 日差しパネル（右列） -->
    <div id="sunlight-panel" class="settings-column">
      <h3>日差し</h3>
      <div id="sunlight-list">
        <div class="setting-category"><span>ブルーム</span><input type="checkbox" id="bloomEnabled" checked></div>
        <div class="setting-item">
          <label>強度</label>
          <input type="range" id="bloomStrength" min="0" max="3" step="0.05" value="0">
          <span id="bloomStrengthValue">0</span>
        </div>
        <div class="setting-item">
          <label>半径</label>
          <input type="range" id="bloomRadius" min="0" max="1" step="0.01" value="0.4">
          <span id="bloomRadiusValue">0.4</span>
        </div>
        <div class="setting-item dual-range-container">
          <label>閾値</label>
          <div class="dual-range" id="bloomThresholdRange" data-min="0" data-max="1">
            <div class="range-track"></div>
            <div class="range-selected"></div>
            <div class="range-handle min-handle" title="下限"></div>
            <div class="range-handle max-handle" title="上限"></div>
            <div class="current-marker" title="現在値"></div>
          </div>
          <div class="range-values">
            <span id="bloomThresholdMinVal">0.8</span>
            <span id="bloomThresholdMaxVal">0.8</span>
          </div>
        </div>
        <div class="setting-category"><span>レンズフレア</span><input type="checkbox" id="flareEnabled" checked></div>
        <div class="setting-item">
          <label>強度</label>
          <input type="range" id="lensFlareIntensity" min="0" max="3" step="0.05" value="0">
          <span id="lensFlareIntensityValue">0</span>
        </div>
        <div class="setting-item">
          <label>にじみ</label>
          <input type="range" id="lensFlareBlur" min="0" max="3" step="0.05" value="0">
          <span id="lensFlareBlurValue">0</span>
        </div>
        <div class="setting-item">
          <label>X位置</label>
          <input type="range" id="sunPosX" min="-200" max="200" step="5" value="50">
          <span id="sunPosXValue">50</span>
        </div>
        <div class="setting-item">
          <label>Y位置</label>
          <input type="range" id="sunPosY" min="0" max="300" step="5" value="100">
          <span id="sunPosYValue">100</span>
        </div>
        <div class="setting-item">
          <label>Z位置</label>
          <input type="range" id="sunPosZ" min="-200" max="200" step="5" value="50">
          <span id="sunPosZValue">50</span>
        </div>
        <div class="setting-category"><span>雲の影</span><input type="checkbox" id="cloudShadowEnabled" checked></div>
        <div class="setting-item">
          <label>濃さ</label>
          <input type="range" id="cloudShadowIntensity" min="0" max="1" step="0.05" value="0">
          <span id="cloudShadowIntensityValue">0</span>
        </div>
        <div class="setting-item">
          <label>速度</label>
          <input type="range" id="cloudShadowSpeed" min="0" max="5" step="0.1" value="1">
          <span id="cloudShadowSpeedValue">1</span>
        </div>
        <div class="setting-item">
          <label>スケール</label>
          <input type="range" id="cloudShadowScale" min="0.5" max="5" step="0.1" value="2">
          <span id="cloudShadowScaleValue">2</span>
        </div>
        <div class="setting-item">
          <label>方向(°)</label>
          <input type="range" id="cloudShadowDirection" min="0" max="360" step="5" value="45">
          <span id="cloudShadowDirectionValue">45</span>
        </div>
        <div class="setting-item">
          <label>日向コントラスト</label>
          <input type="range" id="cloudShadowContrast" min="0" max="3" step="0.05" value="0">
          <span id="cloudShadowContrastValue">0</span>
        </div>
        <div class="setting-category"><span>影</span><input type="checkbox" id="shadowEnabled"></div>
        <div class="setting-item">
          <label>濃さ</label>
          <input type="range" id="shadowOpacity" min="0" max="1" step="0.05" value="0.3">
          <span id="shadowOpacityValue">0.3</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 画像配置パネル（メインエリア上部） -->
  <div id="image-panel">
    <h3>画像設定</h3>
    <div id="image-list">
      <!-- スカイドーム（背景） -->
      <div class="image-section">
        <div class="setting-category">背景</div>
        <div class="image-row">
          <div class="drop-zone" id="skyDomeDropZone">
            <img id="skyDomeImagePreview" class="drop-zone-preview" style="display: none;">
            <video id="skyDomeVideoPreview" class="drop-zone-preview" style="display: none;" muted loop></video>
            <span class="drop-zone-text" id="skyDomeDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="skyDomeImageLabel">ファイル選択</label>
            <button class="library-btn" data-slot="skyDome">ライブラリ</button>
            <input type="file" id="skyDomeImageInput" accept="image/*,video/mp4,video/webm">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>透明度</label><input type="range" id="skyDomeOpacity" min="0.1" max="1" step="0.05" value="1"><span id="skyDomeOpacityValue">1</span></div>
            <div class="control-row"><label>範囲(度)</label><input type="range" id="skyDomeRange" min="60" max="360" step="10" value="180"><span id="skyDomeRangeValue">180</span></div>
            <div class="control-row"><label>距離</label><input type="range" id="skyDomeRadius" min="100" max="3000" step="50" value="2000"><span id="skyDomeRadiusValue">2000</span></div>
            <button id="skyDomeVideoPause" class="video-pause-btn" style="display:none;" title="動画を一時停止/再生"><i class="fa-solid fa-pause"></i></button>
            <button id="skyDomeImageClear" class="clear-btn-small">クリア</button>
          </div>
        </div>
      </div>

      <!-- 床画像 -->
      <div class="image-section">
        <div class="setting-category">床</div>
        <div class="image-row">
          <div class="drop-zone" id="floorDropZone">
            <img id="floorImagePreview" class="drop-zone-preview" style="display: none;">
            <video id="floorVideoPreview" class="drop-zone-preview" style="display: none;" muted loop></video>
            <span class="drop-zone-text" id="floorDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="floorImageLabel">ファイル選択</label>
            <button class="library-btn" data-slot="floor">ライブラリ</button>
            <input type="file" id="floorImageInput" accept="image/*,video/mp4,video/webm">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>サイズ</label><input type="range" id="floorImageSize" min="50" max="3000" step="10" value="300"><span id="floorImageSizeValue">300</span></div>
            <div class="control-row"><label>透明度</label><input type="range" id="floorImageOpacity" min="0.1" max="1" step="0.05" value="0.8"><span id="floorImageOpacityValue">0.8</span></div>
            <div class="control-row"><label>曲率</label><input type="range" id="floorCurvature" min="0" max="0.0003" step="0.00001" value="0"><span id="floorCurvatureValue">0</span></div>
            <div class="control-row"><label><input type="checkbox" id="floorImageFlip">反転</label></div>
            <div class="control-row chroma-key-row"><label>透過色</label><input type="color" id="floorChromaColor" value="#00ff00"><input type="range" id="floorChromaThreshold" min="0" max="1" step="0.01" value="0"><span id="floorChromaThresholdValue">0</span></div>
            <button id="floorVideoPause" class="video-pause-btn" style="display:none;" title="動画を一時停止/再生"><i class="fa-solid fa-pause"></i></button>
            <button id="floorImageClear" class="clear-btn-small">クリア</button>
          </div>
        </div>
      </div>

      <!-- 左側面画像 -->
      <div class="image-section">
        <div class="setting-category">左側面</div>
        <div class="image-row">
          <div class="drop-zone" id="leftWallDropZone">
            <img id="leftWallImagePreview" class="drop-zone-preview" style="display: none;">
            <video id="leftWallVideoPreview" class="drop-zone-preview" style="display: none;" muted loop></video>
            <span class="drop-zone-text" id="leftWallDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="leftWallImageLabel">ファイル選択</label>
            <button class="library-btn" data-slot="leftWall">ライブラリ</button>
            <input type="file" id="leftWallImageInput" accept="image/*,video/mp4,video/webm">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>サイズ</label><input type="range" id="leftWallImageSize" min="50" max="1000" step="10" value="300"><span id="leftWallImageSizeValue">300</span></div>
            <div class="control-row"><label>透明度</label><input type="range" id="leftWallImageOpacity" min="0.1" max="1" step="0.05" value="0.8"><span id="leftWallImageOpacityValue">0.8</span></div>
            <div class="control-row"><label><input type="checkbox" id="leftWallImageFlip">反転</label></div>
            <div class="control-row chroma-key-row"><label>透過色</label><input type="color" id="leftWallChromaColor" value="#00ff00"><input type="range" id="leftWallChromaThreshold" min="0" max="1" step="0.01" value="0"><span id="leftWallChromaThresholdValue">0</span></div>
            <button id="leftWallVideoPause" class="video-pause-btn" style="display:none;" title="動画を一時停止/再生"><i class="fa-solid fa-pause"></i></button>
            <button id="leftWallImageClear" class="clear-btn-small">クリア</button>
          </div>
        </div>
      </div>

      <!-- 右側面画像 -->
      <div class="image-section">
        <div class="setting-category">右側面</div>
        <div class="image-row">
          <div class="drop-zone" id="rightWallDropZone">
            <img id="rightWallImagePreview" class="drop-zone-preview" style="display: none;">
            <video id="rightWallVideoPreview" class="drop-zone-preview" style="display: none;" muted loop></video>
            <span class="drop-zone-text" id="rightWallDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="rightWallImageLabel">ファイル選択</label>
            <button class="library-btn" data-slot="rightWall">ライブラリ</button>
            <input type="file" id="rightWallImageInput" accept="image/*,video/mp4,video/webm">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>サイズ</label><input type="range" id="rightWallImageSize" min="50" max="1000" step="10" value="300"><span id="rightWallImageSizeValue">300</span></div>
            <div class="control-row"><label>透明度</label><input type="range" id="rightWallImageOpacity" min="0.1" max="1" step="0.05" value="0.8"><span id="rightWallImageOpacityValue">0.8</span></div>
            <div class="control-row"><label><input type="checkbox" id="rightWallImageFlip">反転</label></div>
            <div class="control-row chroma-key-row"><label>透過色</label><input type="color" id="rightWallChromaColor" value="#00ff00"><input type="range" id="rightWallChromaThreshold" min="0" max="1" step="0.01" value="0"><span id="rightWallChromaThresholdValue">0</span></div>
            <button id="rightWallVideoPause" class="video-pause-btn" style="display:none;" title="動画を一時停止/再生"><i class="fa-solid fa-pause"></i></button>
            <button id="rightWallImageClear" class="clear-btn-small">クリア</button>
          </div>
        </div>
      </div>

      <!-- 奥側画像 -->
      <div class="image-section">
        <div class="setting-category">奥側</div>
        <div class="image-row">
          <div class="drop-zone" id="backWallDropZone">
            <img id="backWallImagePreview" class="drop-zone-preview" style="display: none;">
            <video id="backWallVideoPreview" class="drop-zone-preview" style="display: none;" muted loop></video>
            <span class="drop-zone-text" id="backWallDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="backWallImageLabel">ファイル選択</label>
            <button class="library-btn" data-slot="backWall">ライブラリ</button>
            <input type="file" id="backWallImageInput" accept="image/*,video/mp4,video/webm">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>サイズ</label><input type="range" id="backWallImageSize" min="50" max="1000" step="10" value="300"><span id="backWallImageSizeValue">300</span></div>
            <div class="control-row"><label>X位置</label><input type="range" id="backWallImageX" min="0" max="500" step="10" value="250"><span id="backWallImageXValue">250</span></div>
            <div class="control-row"><label>透明度</label><input type="range" id="backWallImageOpacity" min="0.1" max="1" step="0.05" value="0.8"><span id="backWallImageOpacityValue">0.8</span></div>
            <div class="control-row"><label><input type="checkbox" id="backWallImageFlip">反転</label></div>
            <div class="control-row chroma-key-row"><label>透過色</label><input type="color" id="backWallChromaColor" value="#00ff00"><input type="range" id="backWallChromaThreshold" min="0" max="1" step="0.01" value="0"><span id="backWallChromaThresholdValue">0</span></div>
            <button id="backWallVideoPause" class="video-pause-btn" style="display:none;" title="動画を一時停止/再生"><i class="fa-solid fa-pause"></i></button>
            <button id="backWallImageClear" class="clear-btn-small">クリア</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Three.js キャンバス -->
  <div id="canvas-container"></div>

  <!-- 表示設定パネル（プレビュー下段・横並び） -->
  <div id="display-settings-panel">
    <h3>表示設定</h3>
    <div class="sections-row">
    <div class="display-section">
      <div class="setting-category">ノート</div>
      <div class="setting-item">
        <label>太さ</label>
        <input type="range" id="noteHeight" min="0.3" max="3" step="0.1" value="0.8">
        <span id="noteHeightValue">0.8</span>
      </div>
      <div class="setting-item">
        <label>奥行き</label>
        <input type="range" id="noteDepth" min="1" max="10" step="0.5" value="1">
        <span id="noteDepthValue">1</span>
      </div>
      <div class="setting-item">
        <label>透明度</label>
        <input type="range" id="noteOpacity" min="0.1" max="1" step="0.05" value="0.85">
        <span id="noteOpacityValue">0.85</span>
      </div>
    </div>
    <div class="display-section">
      <div class="setting-category">レイアウト</div>
      <div class="setting-item">
        <label>トラック間隔</label>
        <input type="range" id="trackSpacing" min="1" max="30" step="0.5" value="6">
        <span id="trackSpacingValue">6</span>
      </div>
      <div class="setting-item">
        <label>時間スケール</label>
        <input type="range" id="timeScale" min="10" max="300" step="5" value="50">
        <span id="timeScaleValue">50</span>
      </div>
      <div class="setting-item">
        <label>縦スケール</label>
        <input type="range" id="pitchScale" min="0.5" max="10" step="0.1" value="1">
        <span id="pitchScaleValue">1</span>
      </div>
    </div>
    <div class="display-section">
      <div class="setting-category">タイムライン</div>
      <div class="setting-item">
        <label>幕の透明度</label>
        <input type="range" id="timelineOpacity" min="0" max="0.5" step="0.05" value="0.25">
        <span id="timelineOpacityValue">0.25</span>
      </div>
      <div class="setting-item">
        <label>X位置</label>
        <input type="range" id="timelineX" min="-500" max="500" step="5" value="0">
        <span id="timelineXValue">0</span>
      </div>
      <div class="setting-item">
        <label>幕の色</label>
        <input type="color" id="timelineColor" value="#ff4444">
      </div>
    </div>
    <div class="display-section">
      <div class="setting-category">表示</div>
      <div class="setting-item">
        <label>背景色（上）</label>
        <input type="color" id="bgColorTop" value="#1a1a2e">
      </div>
      <div class="setting-item">
        <label>背景色（下）</label>
        <input type="color" id="bgColorBottom" value="#0a0a15">
      </div>
      <div class="setting-item">
        <button id="bgColorSwap" style="padding: 4px 8px; font-size: 11px;"><i class="fa-solid fa-arrows-up-down"></i> 上下入替</button>
      </div>
    </div>
    <div class="display-section">
      <div class="setting-category">グリッド</div>
      <div class="setting-item">
        <label>透明度</label>
        <input type="range" id="gridOpacity" min="0" max="1" step="0.1" value="0.5">
        <span id="gridOpacityValue">0.5</span>
      </div>
      <div class="setting-item">
        <label>大きさ</label>
        <input type="range" id="gridSize" min="100" max="2000" step="100" value="500">
        <span id="gridSizeValue">500</span>
      </div>
      <div class="setting-item">
        <label>色</label>
        <input type="color" id="gridColor" value="#444444">
      </div>
    </div>
    </div>
  </div>

  <!-- トラック情報パネル（右） -->
  <div id="track-panel">
    <h3>トラック情報</h3>
    <div id="track-list"></div>
  </div>

  <!-- プリセット保存モーダル -->
  <div id="presetModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h3>プリセット保存</h3>
      <input type="text" id="presetNameInput" placeholder="プリセット名を入力...">
      <div id="presetOverwriteWarning" style="display:none;">同名のプリセットを上書きします</div>
      <div class="modal-buttons">
        <button id="presetSaveConfirm">保存</button>
        <button id="presetSaveCancel">キャンセル</button>
      </div>
    </div>
  </div>

  <!-- 公開モーダル -->
  <div id="publishModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h3>ビューアーを公開</h3>
      <input type="text" id="publishSongName" placeholder="曲名（英数字・ハイフン・アンダースコア）">
      <div id="publishStatus" style="display:none;"></div>
      <div class="modal-buttons">
        <button id="publishConfirm">公開</button>
        <button id="publishCancel">キャンセル</button>
      </div>
    </div>
  </div>

  <!-- メディアライブラリモーダル -->
  <div id="mediaLibraryModal" class="modal-overlay modal-centered" style="display:none;">
    <div class="modal-content media-library-modal">
      <h3>メディアライブラリ</h3>
      <div id="mediaLibraryGrid" class="media-grid"></div>
      <div class="modal-buttons">
        <button id="mediaLibraryCancel">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 360度書き出しモーダル -->
  <div id="export360Modal" class="modal-overlay modal-centered" style="display:none;">
    <div class="modal-content e360-modal">
      <h3><i class="fa-solid fa-vr-cardboard"></i> 360度動画書き出し</h3>
      <div class="e360-settings">
        <div class="e360-row">
          <label>解像度</label>
          <select id="e360Resolution">
            <option value="2048">2K (2048×1024)</option>
            <option value="3840" selected>4K (3840×1920)</option>
          </select>
        </div>
        <div class="e360-row">
          <label>FPS</label>
          <select id="e360Fps">
            <option value="30" selected>30</option>
            <option value="60">60</option>
          </select>
        </div>
        <div class="e360-row">
          <label>キューブ面サイズ</label>
          <select id="e360CubeSize">
            <option value="1024">1024 (速い)</option>
            <option value="2048" selected>2048 (標準)</option>
          </select>
        </div>
        <div class="e360-row">
          <label>カメラ位置</label>
          <div class="e360-cam-inputs">
            <label>X<input type="number" id="e360CamX" value="0"></label>
            <label>Y<input type="number" id="e360CamY" value="150"></label>
            <label>Z<input type="number" id="e360CamZ" value="0"></label>
          </div>
        </div>
        <div class="e360-row">
          <label>範囲 (秒)</label>
          <div class="e360-range-inputs">
            <label>開始<input type="number" id="e360Start" value="0" min="0" step="0.1"></label>
            <label>終了<input type="number" id="e360End" value="0" min="0" step="0.1"></label>
          </div>
        </div>
      </div>
      <div id="e360Progress" class="e360-progress" style="display:none;">
        <div class="e360-progress-track">
          <div id="e360ProgressBar" class="e360-progress-bar"></div>
        </div>
        <div id="e360StatusText" class="e360-status"></div>
      </div>
      <div class="modal-buttons">
        <button id="e360StartBtn"><i class="fa-solid fa-circle-play"></i> 書き出し開始</button>
        <button id="e360CancelBtn">キャンセル</button>
        <button id="e360CloseBtn">閉じる</button>
      </div>
    </div>
  </div>

  <!-- ライブラリ読み込み -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.28/build/Midi.min.js"></script>

  <script src="src/presetManager.js"></script>
  <script src="src/viewerExport.js"></script>
  <script type="module" src="src/main.js"></script>
  <script src="src/export360.js"></script>
</body>
</html>
