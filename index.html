<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIDI Orchestra Visualizer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- コントロールパネル -->
  <div id="controls">
    <div class="control-group file-inputs">
      <div id="midiDropZone" class="file-row">
        <label>MIDI</label>
        <input type="file" id="midiInput" accept=".mid,.midi">
        <span id="midiFileName">未選択（ドロップ可）</span>
      </div>
      <div id="audioDropZone" class="file-row">
        <label>音源</label>
        <input type="file" id="audioInput" accept="audio/*">
        <span id="audioFileName">未選択（ドロップ可）</span>
      </div>
    </div>
    <div class="control-group">
      <button id="playBtn" disabled>▶ 再生</button>
      <button id="stopBtn" disabled>■ 停止</button>
      <button id="resetBtn" disabled>|◀ 最初から</button>
    </div>
    <div class="control-group">
      <label>再生位置: <span id="currentTime">0:00</span></label>
    </div>
    <div class="control-group">
      <label>画面比率</label>
      <select id="aspectRatioSelect">
        <option value="16:9">16:9</option>
        <option value="9:16">9:16</option>
        <option value="free">フリー</option>
      </select>
    </div>
  </div>

  <!-- 設定パネルコンテナ（2列） -->
  <div id="settings-container">
    <!-- カメラ設定パネル（左列） -->
    <div id="camera-panel" class="settings-column">
      <h3>カメラ設定</h3>
      <div id="camera-list">
        <!-- X軸（左右） -->
        <div class="setting-category">X (左右) <span id="cameraPosXValue" class="pos-value">-150</span></div>
        <div class="setting-item dual-range-container">
          <div class="dual-range" data-axis="X" data-min="-500" data-max="500">
            <div class="range-track"></div>
            <div class="range-selected"></div>
            <div class="range-handle min-handle" title="範囲下限"></div>
            <div class="range-handle max-handle" title="範囲上限"></div>
            <div class="current-marker" title="現在位置"></div>
          </div>
          <div class="range-values">
            <span id="cameraRangeXMinVal">-200</span>
            <span id="cameraRangeXMaxVal">200</span>
          </div>
        </div>

        <!-- Y軸（高さ） -->
        <div class="setting-category">Y (高さ) <span id="cameraPosYValue" class="pos-value">150</span></div>
        <div class="setting-item dual-range-container">
          <div class="dual-range" data-axis="Y" data-min="-100" data-max="500">
            <div class="range-track"></div>
            <div class="range-selected"></div>
            <div class="range-handle min-handle" title="範囲下限"></div>
            <div class="range-handle max-handle" title="範囲上限"></div>
            <div class="current-marker" title="現在位置"></div>
          </div>
          <div class="range-values">
            <span id="cameraRangeYMinVal">50</span>
            <span id="cameraRangeYMaxVal">300</span>
          </div>
        </div>

        <!-- Z軸（前後） -->
        <div class="setting-category">Z (前後) <span id="cameraPosZValue" class="pos-value">200</span></div>
        <div class="setting-item dual-range-container">
          <div class="dual-range" data-axis="Z" data-min="-500" data-max="500">
            <div class="range-track"></div>
            <div class="range-selected"></div>
            <div class="range-handle min-handle" title="範囲下限"></div>
            <div class="range-handle max-handle" title="範囲上限"></div>
            <div class="current-marker" title="現在位置"></div>
          </div>
          <div class="range-values">
            <span id="cameraRangeZMinVal">100</span>
            <span id="cameraRangeZMaxVal">300</span>
          </div>
        </div>

        <!-- 全体調整 -->
        <div class="setting-category">全体調整</div>
        <div class="setting-item">
          <label>全体の高さ</label>
          <input type="range" id="cameraHeightOffset" min="-200" max="200" step="5" value="0">
          <span id="cameraHeightOffsetValue">0</span>
        </div>
        <div class="setting-item">
          <label>注視点Y</label>
          <input type="range" id="cameraTargetY" min="-100" max="100" step="5" value="0">
          <span id="cameraTargetYValue">0</span>
        </div>

        <!-- 自動切替 -->
        <div class="setting-category">自動切替</div>
        <div class="setting-item">
          <label>
            <input type="checkbox" id="autoCameraEnabled">
            自動カメラ切替
          </label>
        </div>
        <div class="setting-item">
          <label>切替間隔(秒)</label>
          <input type="range" id="autoCameraInterval" min="2" max="20" step="1" value="5">
          <span id="autoCameraIntervalValue">5</span>
        </div>

        <!-- トランジション -->
        <div class="setting-category">トランジション</div>
        <div class="setting-item">
          <label>モード</label>
          <select id="autoCameraMode">
            <option value="continuous">連続（カメラ移動）</option>
            <option value="cut">カット（クロスフェード）</option>
          </select>
        </div>
        <div class="setting-item" id="continuousModeParams">
          <label>移動時間(%)</label>
          <input type="range" id="autoCameraMovePercent" min="10" max="100" step="5" value="50">
          <span id="autoCameraMovePercentValue">50</span>
        </div>
        <div class="setting-item" id="cutModeParams" style="display: none;">
          <label>クロスフェード(秒)</label>
          <input type="range" id="autoCameraCrossfade" min="0.5" max="5" step="0.5" value="1.5">
          <span id="autoCameraCrossfadeValue">1.5</span>
        </div>
      </div>
    </div>

    <!-- エフェクトパネル -->
    <div id="effects-panel" class="settings-column">
      <h3>エフェクト</h3>
      <div id="effects-list">
        <!-- ノート通過時 -->
        <div class="setting-category">ノート通過時</div>
        <div class="setting-item">
          <label>バウンス (0=OFF)</label>
          <input type="range" id="bounceScale" min="0" max="5" step="0.5" value="1">
          <span id="bounceScaleValue">1</span>
        </div>
        <div class="setting-item">
          <label>バウンス時間</label>
          <input type="range" id="bounceDuration" min="0.1" max="0.5" step="0.05" value="0.2">
          <span id="bounceDurationValue">0.2</span>
        </div>
        <div class="setting-item">
          <label>アイコン (0=OFF)</label>
          <input type="range" id="popIconScale" min="0" max="10" step="0.1" value="3">
          <span id="popIconScaleValue">3</span>
        </div>
        <div class="setting-item">
          <label>
            <input type="checkbox" id="rippleEnabled" checked>
            波紋
          </label>
        </div>

        <!-- バスドラ専用 -->
        <div class="setting-category">バスドラ専用</div>
        <div class="setting-item">
          <label>幕フラッシュ</label>
          <input type="range" id="flashEffectIntensity" min="0" max="1" step="0.1" value="0">
          <span id="flashEffectIntensityValue">0</span>
        </div>

        <!-- テンポ専用 -->
        <div class="setting-category">テンポ専用</div>
        <div class="setting-item">
          <label>カメラ回転</label>
          <input type="range" id="beatCameraRotation" min="0" max="1" step="0.1" value="0">
          <span id="beatCameraRotationValue">0</span>
        </div>
        <div class="setting-item">
          <label>背景パルス</label>
          <input type="range" id="beatBackgroundPulse" min="0" max="1" step="0.1" value="0">
          <span id="beatBackgroundPulseValue">0</span>
        </div>
        <div class="setting-item">
          <label>カラーシフト</label>
          <input type="range" id="beatColorShift" min="0" max="1" step="0.1" value="0">
          <span id="beatColorShiftValue">0</span>
        </div>
        <div class="setting-item">
          <label>空間パルス</label>
          <input type="range" id="beatSpacePulse" min="0" max="1" step="0.1" value="0">
          <span id="beatSpacePulseValue">0</span>
        </div>
        <div class="setting-item">
          <label>ストロボ</label>
          <input type="range" id="beatStrobe" min="0" max="1" step="0.1" value="0">
          <span id="beatStrobeValue">0</span>
        </div>

        <!-- 選択式エフェクト -->
        <div class="setting-category">選択式（トリガー切替）</div>
        <div class="setting-item">
          <div class="effect-header">
            <label>カメラ揺れ</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectCameraShakeTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectCameraShakeTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectCameraShake" min="0" max="1" step="0.1" value="0">
          <span id="effectCameraShakeValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>カメラズーム</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectCameraZoomTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectCameraZoomTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectCameraZoom" min="0" max="1" step="0.1" value="0">
          <span id="effectCameraZoomValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>フラッシュ</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectFlashTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectFlashTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectFlash" min="0" max="1" step="0.1" value="0">
          <span id="effectFlashValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>ブラー</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectBlurTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectBlurTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectBlur" min="0" max="1" step="0.1" value="0">
          <span id="effectBlurValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>ひび割れ</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectCrackTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectCrackTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectCrack" min="0" max="1" step="0.1" value="0">
          <span id="effectCrackValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>グリッチ</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectGlitchTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectGlitchTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectGlitch" min="0" max="1" step="0.1" value="0">
          <span id="effectGlitchValue">0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 画像配置パネル（メインエリア上部） -->
  <div id="image-panel">
    <h3>画像設定</h3>
    <div id="image-list">
      <!-- スカイドーム（背景） -->
      <div class="image-section">
        <div class="setting-category">背景</div>
        <div class="image-row">
          <div class="drop-zone" id="skyDomeDropZone">
            <img id="skyDomeImagePreview" class="drop-zone-preview" style="display: none;">
            <video id="skyDomeVideoPreview" class="drop-zone-preview" style="display: none;" muted loop></video>
            <span class="drop-zone-text" id="skyDomeDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="skyDomeImageLabel">ファイル選択</label>
            <input type="file" id="skyDomeImageInput" accept="image/*,video/mp4,video/webm">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>透明度</label><input type="range" id="skyDomeOpacity" min="0.1" max="1" step="0.05" value="1"><span id="skyDomeOpacityValue">1</span></div>
            <div class="control-row"><label>範囲(度)</label><input type="range" id="skyDomeRange" min="60" max="360" step="10" value="180"><span id="skyDomeRangeValue">180</span></div>
            <div class="control-row"><label>距離</label><input type="range" id="skyDomeRadius" min="100" max="3000" step="50" value="2000"><span id="skyDomeRadiusValue">2000</span></div>
            <button id="skyDomeImageClear" class="clear-btn-small">クリア</button>
          </div>
        </div>
      </div>

      <!-- 床画像 -->
      <div class="image-section">
        <div class="setting-category">床</div>
        <div class="image-row">
          <div class="drop-zone" id="floorDropZone">
            <img id="floorImagePreview" class="drop-zone-preview" style="display: none;">
            <span class="drop-zone-text" id="floorDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="floorImageLabel">画像を選択</label>
            <input type="file" id="floorImageInput" accept="image/*">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>サイズ</label><input type="range" id="floorImageSize" min="50" max="1000" step="10" value="300"><span id="floorImageSizeValue">300</span></div>
            <div class="control-row"><label>透明度</label><input type="range" id="floorImageOpacity" min="0.1" max="1" step="0.05" value="0.8"><span id="floorImageOpacityValue">0.8</span></div>
            <div class="control-row"><label><input type="checkbox" id="floorImageFlip">反転</label><button id="floorImageClear" class="clear-btn-small">クリア</button></div>
          </div>
        </div>
      </div>

      <!-- 左側面画像 -->
      <div class="image-section">
        <div class="setting-category">左側面</div>
        <div class="image-row">
          <div class="drop-zone" id="leftWallDropZone">
            <img id="leftWallImagePreview" class="drop-zone-preview" style="display: none;">
            <span class="drop-zone-text" id="leftWallDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="leftWallImageLabel">画像を選択</label>
            <input type="file" id="leftWallImageInput" accept="image/*">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>サイズ</label><input type="range" id="leftWallImageSize" min="50" max="1000" step="10" value="300"><span id="leftWallImageSizeValue">300</span></div>
            <div class="control-row"><label>透明度</label><input type="range" id="leftWallImageOpacity" min="0.1" max="1" step="0.05" value="0.8"><span id="leftWallImageOpacityValue">0.8</span></div>
            <div class="control-row"><label><input type="checkbox" id="leftWallImageFlip">反転</label><button id="leftWallImageClear" class="clear-btn-small">クリア</button></div>
          </div>
        </div>
      </div>

      <!-- 右側面画像 -->
      <div class="image-section">
        <div class="setting-category">右側面</div>
        <div class="image-row">
          <div class="drop-zone" id="rightWallDropZone">
            <img id="rightWallImagePreview" class="drop-zone-preview" style="display: none;">
            <span class="drop-zone-text" id="rightWallDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="rightWallImageLabel">画像を選択</label>
            <input type="file" id="rightWallImageInput" accept="image/*">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>サイズ</label><input type="range" id="rightWallImageSize" min="50" max="1000" step="10" value="300"><span id="rightWallImageSizeValue">300</span></div>
            <div class="control-row"><label>透明度</label><input type="range" id="rightWallImageOpacity" min="0.1" max="1" step="0.05" value="0.8"><span id="rightWallImageOpacityValue">0.8</span></div>
            <div class="control-row"><label><input type="checkbox" id="rightWallImageFlip">反転</label><button id="rightWallImageClear" class="clear-btn-small">クリア</button></div>
          </div>
        </div>
      </div>

      <!-- 奥側画像 -->
      <div class="image-section">
        <div class="setting-category">奥側</div>
        <div class="image-row">
          <div class="drop-zone" id="backWallDropZone">
            <img id="backWallImagePreview" class="drop-zone-preview" style="display: none;">
            <span class="drop-zone-text" id="backWallDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="backWallImageLabel">画像を選択</label>
            <input type="file" id="backWallImageInput" accept="image/*">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>サイズ</label><input type="range" id="backWallImageSize" min="50" max="1000" step="10" value="300"><span id="backWallImageSizeValue">300</span></div>
            <div class="control-row"><label>X位置</label><input type="range" id="backWallImageX" min="0" max="500" step="10" value="250"><span id="backWallImageXValue">250</span></div>
            <div class="control-row"><label>透明度</label><input type="range" id="backWallImageOpacity" min="0.1" max="1" step="0.05" value="0.8"><span id="backWallImageOpacityValue">0.8</span></div>
            <div class="control-row"><label><input type="checkbox" id="backWallImageFlip">反転</label><button id="backWallImageClear" class="clear-btn-small">クリア</button></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Three.js キャンバス -->
  <div id="canvas-container"></div>

  <!-- 表示設定パネル（プレビュー下段・横並び） -->
  <div id="display-settings-panel">
    <h3>表示設定</h3>
    <div class="sections-row">
    <div class="display-section">
      <div class="setting-category">ノート</div>
      <div class="setting-item">
        <label>太さ</label>
        <input type="range" id="noteHeight" min="0.3" max="3" step="0.1" value="0.8">
        <span id="noteHeightValue">0.8</span>
      </div>
      <div class="setting-item">
        <label>奥行き</label>
        <input type="range" id="noteDepth" min="1" max="10" step="0.5" value="1">
        <span id="noteDepthValue">1</span>
      </div>
      <div class="setting-item">
        <label>透明度</label>
        <input type="range" id="noteOpacity" min="0.1" max="1" step="0.05" value="0.85">
        <span id="noteOpacityValue">0.85</span>
      </div>
    </div>
    <div class="display-section">
      <div class="setting-category">レイアウト</div>
      <div class="setting-item">
        <label>トラック間隔</label>
        <input type="range" id="trackSpacing" min="1" max="30" step="0.5" value="6">
        <span id="trackSpacingValue">6</span>
      </div>
      <div class="setting-item">
        <label>時間スケール</label>
        <input type="range" id="timeScale" min="10" max="300" step="5" value="50">
        <span id="timeScaleValue">50</span>
      </div>
      <div class="setting-item">
        <label>Y軸スケール</label>
        <input type="range" id="pitchScale" min="0.5" max="10" step="0.1" value="1">
        <span id="pitchScaleValue">1</span>
      </div>
    </div>
    <div class="display-section">
      <div class="setting-category">タイムライン</div>
      <div class="setting-item">
        <label>幕の透明度</label>
        <input type="range" id="timelineOpacity" min="0" max="0.5" step="0.05" value="0.25">
        <span id="timelineOpacityValue">0.25</span>
      </div>
      <div class="setting-item">
        <label>幕の色</label>
        <input type="color" id="timelineColor" value="#ff4444">
      </div>
    </div>
    <div class="display-section">
      <div class="setting-category">表示</div>
      <div class="setting-item">
        <label>背景色（上）</label>
        <input type="color" id="bgColorTop" value="#1a1a2e">
      </div>
      <div class="setting-item">
        <label>背景色（下）</label>
        <input type="color" id="bgColorBottom" value="#0a0a15">
      </div>
      <div class="setting-item">
        <button id="bgColorSwap" style="padding: 4px 8px; font-size: 11px;">↕ 上下入替</button>
      </div>
    </div>
    <div class="display-section">
      <div class="setting-category">グリッド</div>
      <div class="setting-item">
        <label>透明度</label>
        <input type="range" id="gridOpacity" min="0" max="1" step="0.1" value="0.5">
        <span id="gridOpacityValue">0.5</span>
      </div>
      <div class="setting-item">
        <label>大きさ</label>
        <input type="range" id="gridSize" min="100" max="2000" step="100" value="500">
        <span id="gridSizeValue">500</span>
      </div>
      <div class="setting-item">
        <label>色</label>
        <input type="color" id="gridColor" value="#444444">
      </div>
    </div>
    </div>
  </div>

  <!-- トラック情報パネル（右） -->
  <div id="track-panel">
    <h3>トラック情報</h3>
    <div id="track-list"></div>
  </div>

  <!-- ライブラリ読み込み -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.28/build/Midi.min.js"></script>

  <script type="module" src="src/main.js"></script>
</body>
</html>
