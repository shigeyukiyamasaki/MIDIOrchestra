<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>MIDI Orchestra Viewer</title>
  <link rel="stylesheet" href="style.css?v=20260213c">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    /* ビューアーモード: 編集パネルを非表示、キャンバスを全画面化 */
    #controls, #settings-container, #image-panel,
    #display-settings-panel, #track-panel { display: none !important; }
    #canvas-container {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
    }
    @media (max-width: 768px) and (orientation: landscape) {
      #canvas-container {
        left: 140px !important;
        right: 0 !important;
        width: calc(100vw - 140px) !important;
        top: 0 !important;
        bottom: auto !important;
        height: calc(100dvh - 40px) !important;
        align-items: flex-start !important;
        justify-content: flex-end !important;
        overflow: hidden !important;
      }
    }
    #presetModal { display: none !important; }
    #viewer-loading-blur {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 9999;
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      background: rgba(0,0,0,0.3);
      transition: opacity 0.8s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 18px;
      letter-spacing: 2px;
    }
    #viewer-loading-blur.fade-out {
      opacity: 0;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="viewer-loading-blur">Loading...</div>
  <!-- コントロールパネル（非表示だがDOM互換性のため残す） -->
  <div id="controls">
    <div class="control-group file-inputs">
      <div id="midiDropZone" class="file-row">
        <span class="file-label">MIDI</span>
        <input type="file" id="midiInput" accept=".mid,.midi">
        <span id="midiFileName">未選択（ドロップ可）</span>
        <button id="midiClearBtn" class="clear-btn" style="display:none;">✕</button>
      </div>
      <div id="audioDropZone" class="file-row">
        <span class="file-label">音源</span>
        <input type="file" id="audioInput" accept="audio/*">
        <span id="audioFileName">未選択（ドロップ可）</span>
        <button id="audioClearBtn" class="clear-btn" style="display:none;">✕</button>
      </div>
    </div>
    <div class="control-group sync-controls">
      <div class="sync-row">
        <label>MIDI遅延</label>
        <input type="range" id="midiDelay" min="0" max="3" step="0.05" value="0">
        <span id="midiDelayValue">0.00秒</span>
      </div>
      <div class="sync-row">
        <label>音源遅延</label>
        <input type="range" id="audioDelay" min="0" max="3" step="0.05" value="0">
        <span id="audioDelayValue">0.00秒</span>
      </div>
    </div>
    <div class="control-group">
      <button id="playBtn" disabled>▶</button>
      <button id="stopBtn" disabled>■</button>
    </div>
    <div class="control-group">
      <label>再生位置: <span id="currentTime">0:00</span></label>
    </div>
    <div class="control-group">
      <label>画面比率</label>
      <select id="aspectRatioSelect">
        <option value="16:9">16:9</option>
        <option value="9:16">9:16</option>
        <option value="free">フリー</option>
      </select>
    </div>
    <div class="control-group preset-controls">
      <button id="presetSaveBtn">💾 保存</button>
      <select id="presetSelect"><option value="">プリセット選択...</option></select>
      <button id="presetLoadBtn">📂 読込</button>
      <button id="presetDeleteBtn">🗑️</button>
    </div>
  </div>

  <!-- プリセット保存モーダル（DOM互換性のため残す） -->
  <div id="presetModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h3>プリセット保存</h3>
      <input type="text" id="presetNameInput" placeholder="プリセット名を入力...">
      <div id="presetOverwriteWarning" style="display:none;">同名のプリセットを上書きします</div>
      <div class="modal-buttons">
        <button id="presetSaveConfirm">保存</button>
        <button id="presetSaveCancel">キャンセル</button>
      </div>
    </div>
  </div>

  <!-- 設定パネルコンテナ（2列） -->
  <div id="settings-container">
    <!-- カメラ設定パネル（左列） -->
    <div id="camera-panel" class="settings-column">
      <h3>カメラ設定</h3>
      <div id="camera-list">
        <div class="setting-category">X (左右) <span id="cameraPosXValue" class="pos-value">-150</span></div>
        <div class="setting-item dual-range-container">
          <div class="dual-range" data-axis="X" data-min="-500" data-max="500">
            <div class="range-track"></div>
            <div class="range-selected"></div>
            <div class="range-handle min-handle" title="範囲下限"></div>
            <div class="range-handle max-handle" title="範囲上限"></div>
            <div class="current-marker" title="現在位置"></div>
          </div>
          <div class="range-values">
            <span id="cameraRangeXMinVal">-200</span>
            <span id="cameraRangeXMaxVal">200</span>
          </div>
        </div>
        <div class="setting-category">Y (高さ) <span id="cameraPosYValue" class="pos-value">150</span></div>
        <div class="setting-item dual-range-container">
          <div class="dual-range" data-axis="Y" data-min="-100" data-max="500">
            <div class="range-track"></div>
            <div class="range-selected"></div>
            <div class="range-handle min-handle" title="範囲下限"></div>
            <div class="range-handle max-handle" title="範囲上限"></div>
            <div class="current-marker" title="現在位置"></div>
          </div>
          <div class="range-values">
            <span id="cameraRangeYMinVal">50</span>
            <span id="cameraRangeYMaxVal">300</span>
          </div>
        </div>
        <div class="setting-category">Z (前後) <span id="cameraPosZValue" class="pos-value">200</span></div>
        <div class="setting-item dual-range-container">
          <div class="dual-range" data-axis="Z" data-min="-500" data-max="500">
            <div class="range-track"></div>
            <div class="range-selected"></div>
            <div class="range-handle min-handle" title="範囲下限"></div>
            <div class="range-handle max-handle" title="範囲上限"></div>
            <div class="current-marker" title="現在位置"></div>
          </div>
          <div class="range-values">
            <span id="cameraRangeZMinVal">100</span>
            <span id="cameraRangeZMaxVal">300</span>
          </div>
        </div>
        <div class="setting-category">中心点</div>
        <div class="setting-item">
          <label>X</label>
          <input type="range" id="cameraTargetX" min="-500" max="500" step="5" value="0">
          <span id="cameraTargetXValue">0</span>
        </div>
        <div class="setting-item">
          <label>Y</label>
          <input type="range" id="cameraTargetY" min="-100" max="100" step="5" value="0">
          <span id="cameraTargetYValue">0</span>
        </div>
        <div class="setting-item">
          <label>Z</label>
          <input type="range" id="cameraTargetZ" min="-500" max="500" step="5" value="0">
          <span id="cameraTargetZValue">0</span>
        </div>
        <div class="setting-category">自動切替</div>
        <div class="setting-item">
          <label>
            <input type="checkbox" id="autoCameraEnabled">
            自動カメラ切替
          </label>
        </div>
        <div class="setting-item">
          <label>切替間隔(秒)</label>
          <input type="range" id="autoCameraInterval" min="2" max="20" step="1" value="5">
          <span id="autoCameraIntervalValue">5</span>
        </div>
        <div class="setting-category">トランジション</div>
        <div class="setting-item">
          <label>モード</label>
          <select id="autoCameraMode">
            <option value="continuous">連続（カメラ移動）</option>
            <option value="cut">カット（クロスフェード）</option>
          </select>
        </div>
        <div class="setting-item" id="continuousModeParams">
          <label>移動時間(%)</label>
          <input type="range" id="autoCameraMovePercent" min="10" max="100" step="5" value="50">
          <span id="autoCameraMovePercentValue">50</span>
        </div>
        <div class="setting-item" id="cutModeParams" style="display: none;">
          <label>クロスフェード(秒)</label>
          <input type="range" id="autoCameraCrossfade" min="0.5" max="5" step="0.5" value="1.5">
          <span id="autoCameraCrossfadeValue">1.5</span>
        </div>
      </div>
    </div>

    <!-- エフェクトパネル -->
    <div id="effects-panel" class="settings-column">
      <h3>エフェクト</h3>
      <div id="effects-list">
        <div class="setting-category">ノート通過時</div>
        <div class="setting-item">
          <label>バウンス (0=OFF)</label>
          <input type="range" id="bounceScale" min="0" max="5" step="0.5" value="1">
          <span id="bounceScaleValue">1</span>
        </div>
        <div class="setting-item">
          <label>バウンス時間</label>
          <input type="range" id="bounceDuration" min="0.1" max="0.5" step="0.05" value="0.2">
          <span id="bounceDurationValue">0.2</span>
        </div>
        <div class="setting-item">
          <label>楽器アイコン (0=OFF)</label>
          <input type="range" id="popIconScale" min="0" max="10" step="0.1" value="3">
          <span id="popIconScaleValue">3</span>
        </div>
        <div class="setting-item">
          <label>
            <input type="checkbox" id="rippleEnabled" checked>
            波紋
          </label>
        </div>
        <div class="setting-category">バスドラ専用</div>
        <div class="setting-item">
          <label>幕フラッシュ</label>
          <input type="range" id="flashEffectIntensity" min="0" max="1" step="0.1" value="0">
          <span id="flashEffectIntensityValue">0</span>
        </div>
        <div class="setting-category">テンポ専用</div>
        <div class="setting-item">
          <label>カメラ回転</label>
          <input type="range" id="beatCameraRotation" min="0" max="1" step="0.1" value="0">
          <span id="beatCameraRotationValue">0</span>
        </div>
        <div class="setting-item">
          <label>背景パルス</label>
          <input type="range" id="beatBackgroundPulse" min="0" max="1" step="0.1" value="0">
          <span id="beatBackgroundPulseValue">0</span>
        </div>
        <div class="setting-item">
          <label>カラーシフト</label>
          <input type="range" id="beatColorShift" min="0" max="1" step="0.1" value="0">
          <span id="beatColorShiftValue">0</span>
        </div>
        <div class="setting-item">
          <label>空間パルス</label>
          <input type="range" id="beatSpacePulse" min="0" max="1" step="0.1" value="0">
          <span id="beatSpacePulseValue">0</span>
        </div>
        <div class="setting-item">
          <label>ストロボ</label>
          <input type="range" id="beatStrobe" min="0" max="1" step="0.1" value="0">
          <span id="beatStrobeValue">0</span>
        </div>
        <div class="setting-category">選択式（トリガー切替）</div>
        <div class="setting-item">
          <div class="effect-header">
            <label>カメラ揺れ</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectCameraShakeTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectCameraShakeTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectCameraShake" min="0" max="1" step="0.1" value="0">
          <span id="effectCameraShakeValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>カメラズーム</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectCameraZoomTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectCameraZoomTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectCameraZoom" min="0" max="1" step="0.1" value="0">
          <span id="effectCameraZoomValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>フラッシュ</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectFlashTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectFlashTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectFlash" min="0" max="1" step="0.1" value="0">
          <span id="effectFlashValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>ブラー</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectBlurTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectBlurTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectBlur" min="0" max="1" step="0.1" value="0">
          <span id="effectBlurValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>ひび割れ</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectCrackTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectCrackTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectCrack" min="0" max="1" step="0.1" value="0">
          <span id="effectCrackValue">0</span>
        </div>
        <div class="setting-item">
          <div class="effect-header">
            <label>グリッチ</label>
            <div class="trigger-radio">
              <label><input type="radio" name="effectGlitchTrigger" value="bass" checked>BD</label>
              <label><input type="radio" name="effectGlitchTrigger" value="tempo">T</label>
            </div>
          </div>
          <input type="range" id="effectGlitch" min="0" max="1" step="0.1" value="0">
          <span id="effectGlitchValue">0</span>
        </div>

      </div>
    </div>
  </div>

  <!-- 画像配置パネル -->
  <div id="image-panel">
    <h3>画像設定</h3>
    <div id="image-list">
      <div class="image-section">
        <div class="setting-category">背景</div>
        <div class="image-row">
          <div class="drop-zone" id="skyDomeDropZone">
            <img id="skyDomeImagePreview" class="drop-zone-preview" style="display: none;">
            <video id="skyDomeVideoPreview" class="drop-zone-preview" style="display: none;" muted loop></video>
            <span class="drop-zone-text" id="skyDomeDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="skyDomeImageLabel">ファイル選択</label>
            <input type="file" id="skyDomeImageInput" accept="image/*,video/mp4,video/webm">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>透明度</label><input type="range" id="skyDomeOpacity" min="0.1" max="1" step="0.05" value="1"><span id="skyDomeOpacityValue">1</span></div>
            <div class="control-row"><label>範囲(度)</label><input type="range" id="skyDomeRange" min="60" max="360" step="10" value="180"><span id="skyDomeRangeValue">180</span></div>
            <div class="control-row"><label>距離</label><input type="range" id="skyDomeRadius" min="100" max="3000" step="50" value="2000"><span id="skyDomeRadiusValue">2000</span></div>
            <div class="control-row"><label>Yオフセット</label><input type="range" id="skyDomeOffsetY" min="-1000" max="1000" step="10" value="0"><span id="skyDomeOffsetYValue">0</span></div>
            <div class="control-row chroma-key-row"><label>透過色</label><input type="color" id="skyDomeChromaColor" value="#00ff00"><input type="range" id="skyDomeChromaThreshold" min="0" max="1" step="0.01" value="0"><span id="skyDomeChromaThresholdValue">0</span></div>
            <button id="skyDomeImageClear" class="clear-btn-small">クリア</button>
          </div>
        </div>
      </div>
      <div class="image-section">
        <div class="setting-category">前景スカイ</div>
        <div class="image-row">
          <div class="drop-zone" id="innerSkyDropZone">
            <img id="innerSkyImagePreview" class="drop-zone-preview" style="display: none;">
            <video id="innerSkyVideoPreview" class="drop-zone-preview" style="display: none;" muted loop></video>
            <span class="drop-zone-text" id="innerSkyDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="innerSkyImageLabel">ファイル選択</label>
            <input type="file" id="innerSkyImageInput" accept="image/*,video/mp4,video/webm" style="display:none;">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>透明度</label><input type="range" id="innerSkyOpacity" min="0.1" max="1" step="0.05" value="1"><span id="innerSkyOpacityValue">1</span></div>
            <div class="control-row"><label>範囲(度)</label><input type="range" id="innerSkyRange" min="60" max="360" step="10" value="180"><span id="innerSkyRangeValue">180</span></div>
            <div class="control-row"><label>距離</label><input type="range" id="innerSkyRadius" min="50" max="2000" step="50" value="500"><span id="innerSkyRadiusValue">500</span></div>
            <div class="control-row"><label>Yオフセット</label><input type="range" id="innerSkyOffsetY" min="-1000" max="1000" step="10" value="0"><span id="innerSkyOffsetYValue">0</span></div>
            <input type="checkbox" id="innerSkyFollowCameraY" style="display:none;">
            <div class="control-row chroma-key-row"><label>透過色</label><input type="color" id="innerSkyChromaColor" value="#00ff00"><input type="range" id="innerSkyChromaThreshold" min="0" max="1" step="0.01" value="0"><span id="innerSkyChromaThresholdValue">0</span></div>
            <button id="innerSkyImageClear" class="clear-btn-small">クリア</button>
          </div>
        </div>
      </div>
      <div class="image-section">
        <div class="setting-category">床</div>
        <div class="image-row">
          <div class="drop-zone" id="floorDropZone">
            <img id="floorImagePreview" class="drop-zone-preview" style="display: none;">
            <video id="floorVideoPreview" class="drop-zone-preview" style="display: none;" muted loop></video>
            <span class="drop-zone-text" id="floorDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="floorImageLabel">ファイル選択</label>
            <input type="file" id="floorImageInput" accept="image/*,video/mp4,video/webm">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>サイズ</label><input type="range" id="floorImageSize" min="50" max="10000" step="10" value="300"><span id="floorImageSizeValue">300</span></div>
            <div class="control-row"><label>透明度</label><input type="range" id="floorImageOpacity" min="0.1" max="1" step="0.05" value="0.8"><span id="floorImageOpacityValue">0.8</span></div>
            <div class="control-row"><label><input type="checkbox" id="floorImageFlip">反転</label></div>
            <div class="control-row chroma-key-row"><label>透過色</label><input type="color" id="floorChromaColor" value="#00ff00"><input type="range" id="floorChromaThreshold" min="0" max="1" step="0.01" value="0"><span id="floorChromaThresholdValue">0</span></div>
            <div class="control-row"><label>曲率</label><input type="range" id="floorCurvature" min="0" max="0.0003" step="0.00001" value="0"><span id="floorCurvatureValue">0</span></div>
            <button id="floorImageClear" class="clear-btn-small">クリア</button>
          </div>
        </div>
      </div>
      <div class="image-section">
        <div class="setting-category">左側面</div>
        <div class="image-row">
          <div class="drop-zone" id="leftWallDropZone">
            <img id="leftWallImagePreview" class="drop-zone-preview" style="display: none;">
            <video id="leftWallVideoPreview" class="drop-zone-preview" style="display: none;" muted loop></video>
            <span class="drop-zone-text" id="leftWallDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="leftWallImageLabel">ファイル選択</label>
            <input type="file" id="leftWallImageInput" accept="image/*,video/mp4,video/webm">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>サイズ</label><input type="range" id="leftWallImageSize" min="50" max="1000" step="10" value="300"><span id="leftWallImageSizeValue">300</span></div>
            <div class="control-row"><label>X位置</label><input type="range" id="leftWallImageX" min="-500" max="500" step="10" value="0"><span id="leftWallImageXValue">0</span></div>
            <div class="control-row"><label>透明度</label><input type="range" id="leftWallImageOpacity" min="0.1" max="1" step="0.05" value="0.8"><span id="leftWallImageOpacityValue">0.8</span></div>
            <div class="control-row"><label><input type="checkbox" id="leftWallImageFlip">反転</label></div>
            <div class="control-row chroma-key-row"><label>透過色</label><input type="color" id="leftWallChromaColor" value="#00ff00"><input type="range" id="leftWallChromaThreshold" min="0" max="1" step="0.01" value="0"><span id="leftWallChromaThresholdValue">0</span></div>
            <button id="leftWallImageClear" class="clear-btn-small">クリア</button>
          </div>
        </div>
      </div>
      <div class="image-section">
        <div class="setting-category">右側面</div>
        <div class="image-row">
          <div class="drop-zone" id="rightWallDropZone">
            <img id="rightWallImagePreview" class="drop-zone-preview" style="display: none;">
            <video id="rightWallVideoPreview" class="drop-zone-preview" style="display: none;" muted loop></video>
            <span class="drop-zone-text" id="rightWallDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="rightWallImageLabel">ファイル選択</label>
            <input type="file" id="rightWallImageInput" accept="image/*,video/mp4,video/webm">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>サイズ</label><input type="range" id="rightWallImageSize" min="50" max="1000" step="10" value="300"><span id="rightWallImageSizeValue">300</span></div>
            <div class="control-row"><label>X位置</label><input type="range" id="rightWallImageX" min="-500" max="500" step="10" value="0"><span id="rightWallImageXValue">0</span></div>
            <div class="control-row"><label>透明度</label><input type="range" id="rightWallImageOpacity" min="0.1" max="1" step="0.05" value="0.8"><span id="rightWallImageOpacityValue">0.8</span></div>
            <div class="control-row"><label><input type="checkbox" id="rightWallImageFlip">反転</label></div>
            <div class="control-row chroma-key-row"><label>透過色</label><input type="color" id="rightWallChromaColor" value="#00ff00"><input type="range" id="rightWallChromaThreshold" min="0" max="1" step="0.01" value="0"><span id="rightWallChromaThresholdValue">0</span></div>
            <button id="rightWallImageClear" class="clear-btn-small">クリア</button>
          </div>
        </div>
      </div>
      <div class="image-section">
        <div class="setting-category">正面</div>
        <div class="image-row">
          <div class="drop-zone" id="centerWallDropZone">
            <img id="centerWallImagePreview" class="drop-zone-preview" style="display: none;">
            <video id="centerWallVideoPreview" class="drop-zone-preview" style="display: none;" muted loop></video>
            <span class="drop-zone-text" id="centerWallDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="centerWallImageLabel">ファイル選択</label>
            <input type="file" id="centerWallImageInput" accept="image/*,video/mp4,video/webm" style="display:none;">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>サイズ</label><input type="range" id="centerWallImageSize" min="50" max="1000" step="10" value="300"><span id="centerWallImageSizeValue">300</span></div>
            <div class="control-row"><label>X位置</label><input type="range" id="centerWallImageX" min="-500" max="500" step="10" value="0"><span id="centerWallImageXValue">0</span></div>
            <div class="control-row"><label>透明度</label><input type="range" id="centerWallImageOpacity" min="0.1" max="1" step="0.05" value="0.8"><span id="centerWallImageOpacityValue">0.8</span></div>
            <div class="control-row"><label><input type="checkbox" id="centerWallImageFlip">反転</label></div>
            <div class="control-row chroma-key-row"><label>透過色</label><input type="color" id="centerWallChromaColor" value="#00ff00"><input type="range" id="centerWallChromaThreshold" min="0" max="1" step="0.01" value="0"><span id="centerWallChromaThresholdValue">0</span></div>
            <button id="centerWallImageClear" class="clear-btn-small">クリア</button>
          </div>
        </div>
      </div>
      <div class="image-section">
        <div class="setting-category">奥側</div>
        <div class="image-row">
          <div class="drop-zone" id="backWallDropZone">
            <img id="backWallImagePreview" class="drop-zone-preview" style="display: none;">
            <video id="backWallVideoPreview" class="drop-zone-preview" style="display: none;" muted loop></video>
            <span class="drop-zone-text" id="backWallDropZoneText">ドラッグ&ドロップ<br>または</span>
            <label class="file-label" id="backWallImageLabel">ファイル選択</label>
            <input type="file" id="backWallImageInput" accept="image/*,video/mp4,video/webm">
          </div>
          <div class="image-controls">
            <div class="control-row"><label>サイズ</label><input type="range" id="backWallImageSize" min="50" max="1000" step="10" value="300"><span id="backWallImageSizeValue">300</span></div>
            <div class="control-row"><label>X位置</label><input type="range" id="backWallImageX" min="0" max="500" step="10" value="250"><span id="backWallImageXValue">250</span></div>
            <div class="control-row"><label>透明度</label><input type="range" id="backWallImageOpacity" min="0.1" max="1" step="0.05" value="0.8"><span id="backWallImageOpacityValue">0.8</span></div>
            <div class="control-row"><label><input type="checkbox" id="backWallImageFlip">反転</label></div>
            <div class="control-row chroma-key-row"><label>透過色</label><input type="color" id="backWallChromaColor" value="#00ff00"><input type="range" id="backWallChromaThreshold" min="0" max="1" step="0.01" value="0"><span id="backWallChromaThresholdValue">0</span></div>
            <button id="backWallImageClear" class="clear-btn-small">クリア</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Three.js キャンバス -->
  <div id="canvas-container">
    <div id="credits-overlay">
      <div id="credits-line1" class="credits-line credits-line-tight" contenteditable="false"></div>
      <div id="credits-line2" class="credits-line" contenteditable="false"></div>
      <div class="credits-line credits-has-prefix" contenteditable="false"><span class="credits-prefix">Comp. </span><span id="credits-line3"></span></div>
      <div class="credits-line credits-has-prefix credits-visible" contenteditable="false"><span class="credits-prefix">Arr. </span><span id="credits-line4">Romashige</span></div>
    </div>
  </div>

  <!-- 表示設定パネル -->
  <div id="display-settings-panel">
    <h3>表示設定</h3>
    <div class="sections-row">
    <div class="display-section">
      <div class="setting-category">ノート</div>
      <div class="setting-item">
        <label>太さ</label>
        <input type="range" id="noteHeight" min="0.3" max="3" step="0.1" value="0.8">
        <span id="noteHeightValue">0.8</span>
      </div>
      <div class="setting-item">
        <label>奥行き</label>
        <input type="range" id="noteDepth" min="1" max="10" step="0.5" value="1">
        <span id="noteDepthValue">1</span>
      </div>
      <div class="setting-item">
        <label>透明度</label>
        <input type="range" id="noteOpacity" min="0.1" max="1" step="0.05" value="0.85">
        <span id="noteOpacityValue">0.85</span>
      </div>
      <div class="setting-item">
        <label>高さオフセット</label>
        <input type="range" id="noteYOffset" min="-100" max="200" step="1" value="0">
        <span id="noteYOffsetValue">0</span>
      </div>
    </div>
    <div class="display-section">
      <div class="setting-category">レイアウト</div>
      <div class="setting-item">
        <label>トラック間隔</label>
        <input type="range" id="trackSpacing" min="1" max="30" step="0.5" value="6">
        <span id="trackSpacingValue">6</span>
      </div>
      <div class="setting-item">
        <label>時間スケール</label>
        <input type="range" id="timeScale" min="10" max="300" step="5" value="50">
        <span id="timeScaleValue">50</span>
      </div>
      <div class="setting-item">
        <label>縦スケール</label>
        <input type="range" id="pitchScale" min="0.5" max="10" step="0.1" value="1">
        <span id="pitchScaleValue">1</span>
      </div>
    </div>
    <div class="display-section">
      <div class="setting-category">タイムライン</div>
      <div class="setting-item">
        <label>幕の透明度</label>
        <input type="range" id="timelineOpacity" min="0" max="0.5" step="0.05" value="0.25">
        <span id="timelineOpacityValue">0.25</span>
      </div>
      <div class="setting-item">
        <label>X位置</label>
        <input type="range" id="timelineX" min="-500" max="500" step="5" value="0">
        <span id="timelineXValue">0</span>
      </div>
      <div class="setting-item">
        <label>幕の色</label>
        <input type="color" id="timelineColor" value="#ff4444">
      </div>
    </div>
    <div class="display-section">
      <div class="setting-category">表示</div>
      <div class="setting-item">
        <label>背景色（上）</label>
        <input type="color" id="bgColorTop" value="#1a1a2e">
      </div>
      <div class="setting-item">
        <label>背景色（下）</label>
        <input type="color" id="bgColorBottom" value="#0a0a15">
      </div>
      <div class="setting-item">
        <button id="bgColorSwap" style="padding: 4px 8px; font-size: 11px;">↕ 上下入替</button>
      </div>
    </div>
    <div class="display-section">
      <div class="setting-category">グリッド</div>
      <div class="setting-item">
        <label>透明度</label>
        <input type="range" id="gridOpacity" min="0" max="1" step="0.1" value="0.5">
        <span id="gridOpacityValue">0.5</span>
      </div>
      <div class="setting-item">
        <label>大きさ</label>
        <input type="range" id="gridSize" min="100" max="2000" step="100" value="500">
        <span id="gridSizeValue">500</span>
      </div>
      <div class="setting-item">
        <label>色</label>
        <input type="color" id="gridColor" value="#444444">
      </div>
    </div>
    </div>
  </div>

  <!-- トラック情報パネル -->
  <div id="track-panel">
    <h3>トラック情報</h3>
    <div id="track-list"></div>
  </div>

  <!-- ビューワー用: エディターと共通のDOM互換要素（非表示） -->
  <div id="viewer-compat-elements" style="display:none !important;">
    <!-- カメラ -->
    <input type="range" id="cameraFloorLimit" min="0" max="100" step="1" value="100"><span id="cameraFloorLimitValue">100</span>
    <!-- ブルーム -->
    <input type="checkbox" id="bloomEnabled" checked>
    <input type="range" id="bloomStrength" min="0" max="3" step="0.05" value="0"><span id="bloomStrengthValue">0</span>
    <input type="range" id="bloomRadius" min="0" max="1" step="0.01" value="0.4"><span id="bloomRadiusValue">0.4</span>
    <div class="dual-range" id="bloomThresholdRange" data-min="0" data-max="1">
      <div class="range-track"></div>
      <div class="range-selected"></div>
      <div class="range-handle min-handle"></div>
      <div class="range-handle max-handle"></div>
      <div class="current-marker"></div>
      <span id="bloomThresholdMinVal">0.8</span>
      <span id="bloomThresholdMaxVal">0.8</span>
    </div>
    <!-- レンズフレア -->
    <input type="checkbox" id="flareEnabled" checked>
    <input type="range" id="lensFlareIntensity" min="0" max="3" step="0.05" value="0"><span id="lensFlareIntensityValue">0</span>
    <input type="range" id="lensFlareBlur" min="0" max="3" step="0.05" value="0"><span id="lensFlareBlurValue">0</span>
    <input type="range" id="sunPosX" min="-200" max="200" step="5" value="50"><span id="sunPosXValue">50</span>
    <input type="range" id="sunPosY" min="0" max="300" step="5" value="100"><span id="sunPosYValue">100</span>
    <input type="range" id="sunPosZ" min="-200" max="200" step="5" value="50"><span id="sunPosZValue">50</span>
    <input type="checkbox" id="sunLightColorEnabled">
    <input type="color" id="sunLightColor" value="#ffffff">
    <input type="range" id="sunLightIntensity" min="0" max="3" step="0.05" value="1"><span id="sunLightIntensityValue">1</span>
    <!-- 雲の影 -->
    <input type="checkbox" id="cloudShadowEnabled" checked>
    <input type="range" id="cloudShadowIntensity" min="0" max="1" step="0.05" value="0"><span id="cloudShadowIntensityValue">0</span>
    <input type="range" id="cloudShadowSpeed" min="0" max="5" step="0.1" value="1"><span id="cloudShadowSpeedValue">1</span>
    <input type="range" id="cloudShadowScale" min="0.5" max="5" step="0.1" value="2"><span id="cloudShadowScaleValue">2</span>
    <input type="range" id="cloudShadowDirection" min="0" max="360" step="5" value="45"><span id="cloudShadowDirectionValue">45</span>
    <input type="range" id="cloudShadowContrast" min="0" max="3" step="0.05" value="0"><span id="cloudShadowContrastValue">0</span>
    <!-- 影 -->
    <input type="checkbox" id="shadowEnabled">
    <input type="radio" name="shadowEnvironment" value="outdoor" checked>
    <input type="radio" name="shadowEnvironment" value="indoor">
    <input type="range" id="shadowOpacity" min="0" max="1" step="0.05" value="0.3"><span id="shadowOpacityValue">0.3</span>
    <input type="checkbox" id="noteShadowEnabled">
    <!-- 天候 -->
    <select id="weatherType"><option value="none">なし</option><option value="snow">雪</option><option value="rain">雨</option><option value="sakura">桜</option><option value="leaves">落ち葉</option><option value="firefly">蛍</option></select>
    <input type="range" id="weatherAmount" min="100" max="50000" step="100" value="3000"><span id="weatherAmountValue">3000</span>
    <input type="range" id="weatherSpeed" min="0.1" max="5" step="0.1" value="1"><span id="weatherSpeedValue">1</span>
    <input type="range" id="weatherAngle" min="0" max="80" step="1" value="0"><span id="weatherAngleValue">0</span>
    <input type="range" id="weatherWindDir" min="0" max="360" step="5" value="0"><span id="weatherWindDirValue">0</span>
    <input type="range" id="weatherSpread" min="100" max="1000" step="50" value="400"><span id="weatherSpreadValue">400</span>
    <!-- 水面 -->
    <input type="checkbox" id="waterSurfaceEnabled">
    <input type="range" id="waterSurfaceScale" min="10" max="100" step="1" value="40"><span id="waterSurfaceScaleValue">40</span>
    <input type="range" id="waterSurfaceSpeed" min="0.1" max="3" step="0.1" value="1"><span id="waterSurfaceSpeedValue">1</span>
    <input type="color" id="waterSurfaceColor" value="#1a3a6a">
    <input type="color" id="waterSurfaceColor2" value="#4a9eed">
    <input type="range" id="waterSurfaceOpacity" min="0" max="1" step="0.05" value="0.6"><span id="waterSurfaceOpacityValue">0.6</span>
    <input type="range" id="waterSurfaceCaustic" min="0" max="1" step="0.05" value="0.5"><span id="waterSurfaceCausticValue">0.5</span>
    <input type="range" id="waterSurfaceWaveHeight" min="0" max="20" step="0.5" value="3"><span id="waterSurfaceWaveHeightValue">3</span>
    <input type="range" id="waterSurfaceHeight" min="-50" max="50" step="1" value="0"><span id="waterSurfaceHeightValue">0</span>
    <!-- 再生制御 -->
    <input type="checkbox" id="loopStartEnabled">
    <input type="range" id="loopStartSeek" min="0" max="1000" step="1" value="0">
    <span id="loopStartTime">-:--.--</span>
    <input type="checkbox" id="loopEndEnabled">
    <input type="range" id="loopEndSeek" min="0" max="1000" step="1" value="1000">
    <span id="loopEndTime">-:--.--</span>
    <input type="range" id="fadeOutDuration" min="0" max="50" step="1" value="0"><span id="fadeOutValue">0</span>
    <!-- スペクトラム -->
    <input type="checkbox" id="audioVisualizerEnabled">
    <select id="audioVisualizerStyle">
      <option value="bar">バー</option>
      <option value="wave">ウェーブ</option>
      <option value="dot">ドット</option>
      <option value="mirror">ミラー</option>
    </select>
    <input type="range" id="audioVisualizerScale" min="0.1" max="3" step="0.1" value="1"><span id="audioVisualizerScaleValue">1</span>
    <input type="range" id="audioVisualizerRadius" min="10" max="200" step="1" value="18"><span id="audioVisualizerRadiusValue">18</span>
    <input type="range" id="audioVisualizerBars" min="16" max="128" step="1" value="64"><span id="audioVisualizerBarsValue">64</span>
    <input type="range" id="audioVisualizerOpacity" min="0" max="1" step="0.05" value="0.9"><span id="audioVisualizerOpacityValue">0.9</span>
    <!-- クレジット -->
    <input type="text" id="creditsLine1">
    <input type="text" id="creditsLine2">
    <input type="text" id="creditsLine3">
    <input type="number" id="creditsSize1" min="8" max="72" value="16">
    <input type="number" id="creditsSize2" min="8" max="72" value="16">
    <input type="number" id="creditsSize3" min="8" max="72" value="16">
    <input type="number" id="creditsSize4" min="8" max="72" value="16">
    <input type="color" id="creditsColor" value="#ffffff">
    <input type="range" id="creditsOpacity" min="0" max="1" step="0.05" value="0.8"><span id="creditsOpacityValue">0.8</span>
  </div>

  <!-- ローディング表示 -->
  <div id="viewerLoading">読み込み中...</div>

  <!-- ビューアー用再生コントロール -->
  <div class="viewer-overlay">
    <button id="viewerRewBtn"><i class="fa-solid fa-backward"></i></button>
    <button id="viewerPlayBtn"><i class="fa-solid fa-play"></i></button>
    <button id="viewerStopBtn"><i class="fa-solid fa-stop"></i></button>
    <button id="viewerFfBtn"><i class="fa-solid fa-forward"></i></button>
    <span id="viewerTime">0:00</span>
    <span id="viewerDuration">/ 0:00</span>
    <input type="range" id="viewerSeek" min="0" max="100" step="0.1" value="0">
  </div>

  <!-- 設定パネルトグルボタン -->
  <button id="viewerSettingsToggle" class="viewer-settings-toggle"><i class="fa-solid fa-sliders"></i></button>

  <!-- サイドパネル -->
  <div class="viewer-side-controls">
    <div class="viewer-lang-toggle"><span id="viewerLangJP" class="active">JP</span><span id="viewerLangEN">EN</span></div>
    <div class="viewer-control-group">
      <label data-en="Center">中心点</label>
      <div><span>X</span><input type="range" id="viewerCenterX" min="-500" max="500" step="5" value="0"></div>
      <div><span>Y</span><input type="range" id="viewerCenterY" min="-500" max="500" step="5" value="0"></div>
      <div><span>Z</span><input type="range" id="viewerCenterZ" min="-500" max="500" step="5" value="0"></div>
    </div>
    <div class="viewer-control-group">
      <label data-en="Note">ノート</label>
      <div><span data-en="Height">太さ</span><input type="range" id="viewerNoteHeight" min="0.3" max="3" step="0.1" value="0.8"></div>
      <div><span data-en="Depth">奥行</span><input type="range" id="viewerNoteDepth" min="1" max="10" step="0.5" value="1"></div>
      <div><span data-en="Opacity">透明</span><input type="range" id="viewerNoteOpacity" min="0.1" max="1" step="0.05" value="0.85"></div>
      <div><span data-en="Y Offset">高さ</span><input type="range" id="viewerNoteYOffset" min="-100" max="200" step="1" value="0"></div>
    </div>
    <div class="viewer-control-group">
      <label data-en="Effect">エフェクト</label>
      <div><span data-en="Bounce">バウンス</span><input type="range" id="viewerBounceScale" min="0" max="5" step="0.5" value="1"></div>
      <div><span data-en="Duration">バウンス時間</span><input type="range" id="viewerBounceDuration" min="0.1" max="0.5" step="0.05" value="0.2"></div>
      <div><span data-en="Icon">楽器アイコン</span><input type="range" id="viewerPopIconScale" min="0" max="10" step="0.1" value="3"></div>
    </div>
    <div class="viewer-control-group">
      <label data-en="Layout">レイアウト</label>
      <div><span data-en="Spacing">トラック間隔</span><input type="range" id="viewerTrackSpacing" min="1" max="30" step="0.5" value="6"></div>
      <div><span data-en="Time">時間スケール</span><input type="range" id="viewerTimeScale" min="10" max="300" step="5" value="50"></div>
      <div><span data-en="Pitch">縦スケール</span><input type="range" id="viewerPitchScale" min="0.5" max="10" step="0.1" value="1"></div>
    </div>
  </div>

  <!-- ライブラリ読み込み -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.28/build/Midi.min.js"></script>

  <script>
    window.VIEWER_MODE = true;
    // URLパラメータから曲名を取得し、対応するデータファイルを動的読み込み
    const params = new URLSearchParams(location.search);
    const song = params.get('song');
    if (song) {
      document.write('<script src="data/' + encodeURIComponent(song) + '.js"><\/script>');
    } else {
      document.write('<script src="viewer-data.js"><\/script>');
    }
  </script>
  <script src="src/presetManager.js?v=20260213c"></script>
  <script type="module" src="src/main.js?v=20260213c"></script>
</body>
</html>
